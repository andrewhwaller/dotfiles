#!/usr/bin/env bash

# Detect OS and set appropriate Tailscale binary path
if [[ "$OSTYPE" == "darwin"* ]]; then
    TAILSCALE_BIN="/Applications/Tailscale.app/Contents/MacOS/Tailscale"
else
    # Linux and other systems - use tailscale from PATH
    TAILSCALE_BIN="tailscale"
fi

PALETTE_PRIMARY="#89B4FA"
PALETTE_ACCENT="#A6E3A1"
PALETTE_TEXT="#CDD6F4"
PALETTE_SUCCESS="#94E2D5"
PALETTE_ERROR="#F38BA8"
PALETTE_WARNING="#FAB387"
PALETTE_SURFACE="#1E1E2E"
PALETTE_SURFACE_HIGHLIGHT="#313244"

install_gum() {
    if [[ "$OSTYPE" == "darwin"* ]]; then
        if command -v brew >/dev/null 2>&1; then
            brew install gum
            return $?
        else
            echo "Homebrew is required to install gum automatically on macOS." >&2
            return 1
        fi
    else
        if command -v apt-get >/dev/null 2>&1; then
            sudo apt-get install -y gum
            return $?
        elif command -v pacman >/dev/null 2>&1; then
            sudo pacman -S --noconfirm gum
            return $?
        elif command -v dnf >/dev/null 2>&1; then
            sudo dnf install -y gum
            return $?
        elif command -v yum >/dev/null 2>&1; then
            sudo yum install -y gum
            return $?
        fi
    fi
    echo "Unable to determine package manager. Install gum manually from https://github.com/charmbracelet/gum." >&2
    return 1
}

ensure_gum() {
    if command -v gum >/dev/null 2>&1; then
        return
    fi

    echo "gum is required to run this script."
    read -r -p "Install gum now? [y/N]: " response
    case "$response" in
        [yY][eE][sS]|[yY])
            if install_gum && command -v gum >/dev/null 2>&1; then
                echo "gum installed successfully."
            else
                echo "Failed to install gum. Please install it manually: https://github.com/charmbracelet/gum" >&2
                exit 1
            fi
            ;;
        *)
            echo "gum is required. Exiting." >&2
            exit 1
            ;;
    esac
}

ensure_gum

format_duration() {
    local total_seconds=$1
    local hours=$((total_seconds / 3600))
    local minutes=$(((total_seconds % 3600) / 60))
    local seconds=$((total_seconds % 60))
    local parts=()
    if (( hours > 0 )); then
        parts+=("${hours}h")
    fi
    if (( minutes > 0 )); then
        parts+=("${minutes}m")
    fi
    parts+=("${seconds}s")
    printf "%s" "${parts[*]}"
}

get_hosts() {
    $TAILSCALE_BIN status | grep -v "^#" | awk '
    function human_bytes(bytes) {
        if (bytes >= 1073741824) return sprintf("%.1fGB", bytes/1073741824)
        if (bytes >= 1048576) return sprintf("%.1fMB", bytes/1048576)
        if (bytes >= 1024) return sprintf("%.1fKB", bytes/1024)
        return bytes "B"
    }
    {
        hostname=$2
        os=$4
        status=""
        for(i=5; i<=NF; i++) {
            word=$i
            # Convert tx/rx bytes to human readable
            if (word ~ /^tx$/ && $(i+1) ~ /^[0-9]+$/) {
                status = status (status ? " " : "") "tx:" human_bytes($(i+1))
                i++
            } else if (word ~ /^rx$/ && $(i+1) ~ /^[0-9]+$/) {
                status = status (status ? " " : "") "rx:" human_bytes($(i+1))
                i++
            } else if (word != "-") {
                gsub(/[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+(\/[0-9]+)?/, "[hidden]", word)
                status = status (status ? " " : "") word
            }
        }
        if (status == "" || status == "-") status="online"
        printf "%s|%s|%s\n", hostname, os, status
    }'
}

export TAILSCALE_BIN
export -f get_hosts
if ! hosts_output=$(gum spin --spinner dot --title "Enumerating Tailscale hosts" -- bash -lc 'get_hosts'); then
    gum style --border double --border-foreground "$PALETTE_ERROR" --padding "0 1" \
        --foreground "$PALETTE_TEXT" \
        "Unable to query Tailscale status. Ensure tailscale is running and you have access."
    exit 1
fi

if [[ -z $hosts_output ]]; then
    gum style --border normal --border-foreground "$PALETTE_WARNING" --padding "0 1" \
        --foreground "$PALETTE_TEXT" \
        "No Tailscale hosts discovered."
    exit 0
fi

host_count=$(printf "%s\n" "$hosts_output" | grep -c .)

gum style ">> Liaison online, select host for transfer:"

if ! selected_row=$(printf "%s\n" "$hosts_output" | gum table \
        --separator '|' \
        --columns "Hostname","OS","Status" \
        --border double \
        --border.foreground "$PALETTE_PRIMARY" \
        --header.foreground "$PALETTE_ACCENT" \
        --cell.foreground "$PALETTE_TEXT" \
        --selected.background "$PALETTE_SURFACE_HIGHLIGHT" \
        --selected.foreground "$PALETTE_ACCENT"); then
    exit 0
fi

IFS='|' read -r hostname host_os host_status <<<"$selected_row"

gum style ">> identity [$USER] (enter to use remote default):"
if ! username=$(gum input --placeholder "$USER" --width 40); then
    exit 0
fi

ssh_opts=()
if [[ -n $TMUX ]]; then
    ssh_opts+=(-o "SendEnv TMUX")
fi

# Legacy theme forwarding removed

if [[ -n $username ]]; then
    target="$username@$hostname"
    display_user="$username"
else
    default_user=$(ssh -G "$hostname" 2>/dev/null | awk '/^user / {print $2; exit}')
    if [[ -z $default_user ]]; then
        default_user="$USER"
    fi
    target="$hostname"
    display_user="$default_user (remote default)"
fi

gum style ">> establishing network link to:"
gum style --margin "0" --padding "0" "  • Host: $hostname"
gum style --margin "0" --padding "0 0 1 0" "  • User: $display_user"
gum confirm \
    --prompt.foreground "$PALETTE_PRIMARY" \
    --selected.foreground "$PALETTE_SURFACE" \
    --selected.background "$PALETTE_ACCENT" \
    --unselected.background "$PALETTE_SURFACE" \
    --unselected.foreground "$PALETTE_TEXT" \
    --padding "0 1" \
    "Proceed?" || exit 0

if [[ -z $username ]]; then
    session_start=$(date +%s)
    ssh "${ssh_opts[@]}" "$hostname"
    exit_code=$?
else
    session_start=$(date +%s)
    ssh "${ssh_opts[@]}" "$username@$hostname"
    exit_code=$?
fi
session_end=$(date +%s)
duration=$((session_end - session_start))
formatted_duration=$(format_duration "$duration")

if [[ $exit_code -ne 0 ]]; then
    gum style --border normal --border-foreground "$PALETTE_ERROR" --padding "0 1" \
        --foreground "$PALETTE_TEXT" \
        "Connection failed: unable to establish link to $hostname (exit code: $exit_code)"
else
    gum style ">> link closed cleanly. ALLMIND exists for all mercenaries."
fi

gum style ">> session summary:"
gum style --border rounded --border-foreground "$PALETTE_PRIMARY" --padding "0 1" \
"Host          $hostname
User          $display_user
OS            $host_os
Telemetry     $host_status
Duration      $formatted_duration
Exit Code     $exit_code"

exit $exit_code
