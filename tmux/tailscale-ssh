#!/usr/bin/env bash

# Detect OS and set appropriate Tailscale binary path
if [[ "$OSTYPE" == "darwin"* ]]; then
    TAILSCALE_BIN="/Applications/Tailscale.app/Contents/MacOS/Tailscale"
else
    # Linux and other systems - use tailscale from PATH
    TAILSCALE_BIN="tailscale"
fi

GREEN='\033[0;32m'
RESET='\033[0m'

get_hosts() {
    $TAILSCALE_BIN status | grep -v "^#" | awk '{
        hostname=$2
        os=$4
        status=""
        for(i=5; i<=NF; i++) {
            if (status == "") status=$i
            else status=status" "$i
        }
        if (status == "-" || status == "") status="online"
        printf "%-20s | %-8s | %s\n", hostname, os, status
    }'
}

selected=$(get_hosts | fzf \
    --color=16 \
    --prompt=">> Liaison online, select host for transfer: " \
    --cycle \
    --bind "shift-tab:up,tab:down" \
    --bind "change:top")

if [[ -z $selected ]]; then
    exit 0
fi

hostname=$(echo "$selected" | awk '{print $1}')

echo -ne "${GREEN}>> identity${RESET} [$USER]: "
read username

ssh_opts=()
if [[ -n $TMUX ]]; then
    ssh_opts+=(-o "SendEnv TMUX")
fi

if [[ -z $username ]]; then
    echo -e "${GREEN}>> establishing network link to $hostname...${RESET}"
    ssh "${ssh_opts[@]}" "$hostname"
else
    echo -e "${GREEN}>> establishing network link to $hostname as $username...${RESET}"
    ssh "${ssh_opts[@]}" "$username@$hostname"
fi
